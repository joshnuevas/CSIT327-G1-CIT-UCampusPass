{% extends "dashboard_app/visitor_dashboard_base.html" %}
{% load static %}
{% block title %}CIT-U Campus Pass - Book a Visit{% endblock %}

{% block book_visit_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'book_visit_app/css/book_visit.css' %}?v={{ now|date:'U' }}">
<style>
.check-in-btn, .check-out-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #8B1538, #6B0F2A);
    color: #FFFFFF;
    border: none;
    border-radius: 50px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(139, 21, 56, 0.3);
}

.check-in-btn:hover, .check-out-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(139, 21, 56, 0.4);
    background: linear-gradient(135deg, #6B0F2A, #8B1538);
}

.check-in-btn.checked {
    background: linear-gradient(135deg, #28a745, #20c997);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.check-in-btn.checked:hover {
    background: linear-gradient(135deg, #20c997, #28a745);
    box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4);
}

.check-in-btn svg, .check-out-btn svg {
    width: 16px;
    height: 16px;
}

.visit-date {
    display: block;
    font-size: 0.9em;
    color: #666;
    margin-top: 4px;
}
</style>
{% endblock %}

{% block content %}
        <div class="welcome-section">
            <h1>Book a Visit</h1>
            <p>Schedule your campus visit</p>
        </div>

        <!-- Booking Form -->
        <div class="form-container">
            <form method="POST" action="{% url 'book_visit_app:book_visit' %}">
                {% csrf_token %}
                <!-- Department -->
                <div class="form-group">
                    <label for="department" class="required">Department</label>
                    <select name="department" id="department" onchange="updatePurposeOptions(); toggleOther('department')" required>
                        <option value="" selected disabled>Select Department</option>
                        <option value="Office of Admissions and Scholarships (OAS)">Office of Admissions and Scholarships (OAS)</option>
                        <option value="Finance and Accounting Office (FAO)">Finance and Accounting Office (FAO)</option>
                        <option value="University Registrar's Office (URO)">University Registrar's Office (URO)</option>
                        <option value="Learning Resource and Activity Center (LRAC)">Learning Resource and Activity Center (LRAC)</option>
                        <option value="Student Success Office (SSO)">Student Success Office (SSO)</option>
                        <option value="Alumni Affairs Office (AAO)">Alumni Affairs Office (AAO)</option>
                        <option value="Networking, Linkages & Relations (NLR)">Networking, Linkages & Relations (NLR)</option>
                        <option value="Human Resource Department (HRD)">Human Resource Department (HRD)</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" name="department_other" id="department_other" placeholder="Please specify department" style="display:none;">
                </div>

                <!-- Purpose -->
                <div class="form-group">
                    <label for="purpose" class="required">Purpose</label>
                    <select name="purpose" id="purpose" onchange="toggleOther('purpose')" required>
                        <option value="" selected disabled>Select Department First</option>
                    </select>
                    <input type="text" name="purpose_other" id="purpose_other" placeholder="Please specify your purpose" style="display:none;">
                </div>

                <!-- Date -->
                <div class="form-group">
                    <label for="visit_date" class="required">Visit Date</label>
                    <input type="date" name="visit_date" id="visit_date" required>
                    <p class="helper-text">Please select your preferred visit date (Monday-Saturday)</p>
                </div>

                <button type="submit" id="submitBtn">Book Visit</button>
            </form>
        </div>

<!-- Warning Modal for Invalid Selections -->
<div id="warningModal" class="modal warning-modal">
    <div class="modal-content warning-content">
        <div class="warning-icon">
            <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        </div>
        <h2 id="warningTitle">Oops!</h2>
        <p id="warningMessage">Something went wrong.</p>
        <button id="warningOkBtn" class="btn-warning">Got it!</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Purpose options for each department
const purposeOptions = {
    "Office of Admissions and Scholarships (OAS)": [
        "Admission Inquiry",
        "Submission of Admission Requirements",
        "Enrollment Processing",
        "Scholarship Application",
        "Scholarship Inquiry",
        "Claiming Scholarship Results",
        "Document Verification (Admission-related)",
        "Other"
    ],
    "Finance and Accounting Office (FAO)": [
        "Tuition Payment",
        "Financial Clearance",
        "Assessment of Fees",
        "Refund Processing",
        "Scholarship / Discount Posting Inquiry",
        "Statement of Account Request",
        "Official Receipt Concerns",
        "Payment Discrepancy Inquiry",
        "Other"
    ],
    "University Registrar's Office (URO)": [
        "Request for Transcript of Records",
        "Request for Certificate (Enrollment, Grades, Good Moral, etc.)",
        "Document Pickup (TOR, Certificates, etc.)",
        "Correction of Student Records",
        "Verification of Academic Credentials",
        "Diploma Request / Release",
        "Enrollment / Registration Concerns",
        "Graduation Evaluation",
        "Other"
    ],
    "Learning Resource and Activity Center (LRAC)": [
        "Library Access",
        "Book Borrowing / Returning",
        "Research Assistance",
        "Use of Study Rooms / Facilities",
        "Access to Archives / Special Collections",
        "Orientation or Library Tour",
        "Resource Reservation (AV Equipment, Materials)",
        "Other"
    ],
    "Student Success Office (SSO)": [
        "Counseling Appointment",
        "Career Guidance / Job Placement",
        "Student Affairs Consultation",
        "Disciplinary Meeting",
        "Mental Health Support Session",
        "Student Organization Concerns",
        "Academic Support / Advising",
        "Other"
    ],
    "Alumni Affairs Office (AAO)": [
        "Alumni Verification",
        "Alumni ID Application / Claiming",
        "Alumni Records Request",
        "Reunion / Event Coordination",
        "Campus Access for Alumni",
        "Donations or Partnerships",
        "Alumni Networking Inquiries",
        "Other"
    ],
    "Networking, Linkages & Relations (NLR)": [
        "Partnership / MOA Meeting",
        "Internship / OJT Coordination",
        "Industry Relations Inquiry",
        "Sponsorship Meeting",
        "External Collaboration",
        "Campus Promotional Activities Coordination",
        "Other"
    ],
    "Human Resource Department (HRD)": [
        "Job Application",
        "Job Interview",
        "Employment Verification",
        "Employee Records Request",
        "Contract Signing",
        "HR Consultation / Meeting",
        "Onboarding / Orientation",
        "Clearance Processing",
        "Other"
    ]
};

function updatePurposeOptions() {
    const departmentSelect = document.getElementById('department');
    const purposeSelect = document.getElementById('purpose');
    const selectedDepartment = departmentSelect.value;

    // Clear current options
    purposeSelect.innerHTML = '';

    if (selectedDepartment === 'Other') {
        // Hide purpose select and show input
        purposeSelect.style.display = 'none';
        document.getElementById('purpose_other').style.display = 'block';
        document.getElementById('purpose_other').required = true;
        return;
    } else if (selectedDepartment && purposeOptions[selectedDepartment]) {
        // Show purpose select and populate options
        purposeSelect.style.display = 'block';
        document.getElementById('purpose_other').style.display = 'none';
        document.getElementById('purpose_other').required = false;
        document.getElementById('purpose_other').value = '';

        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select Purpose';
        defaultOption.selected = true;
        defaultOption.disabled = true;
        purposeSelect.appendChild(defaultOption);

        // Add purpose options
        purposeOptions[selectedDepartment].forEach(purpose => {
            const option = document.createElement('option');
            option.value = purpose;
            option.textContent = purpose;
            purposeSelect.appendChild(option);
        });
    } else {
        // No department selected
        purposeSelect.style.display = 'block';
        document.getElementById('purpose_other').style.display = 'none';
        document.getElementById('purpose_other').required = false;
        document.getElementById('purpose_other').value = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select Department First';
        defaultOption.selected = true;
        defaultOption.disabled = true;
        purposeSelect.appendChild(defaultOption);
    }
}

function toggleOther(field) {
    const select = document.getElementById(field);
    const otherInput = document.getElementById(field + '_other');

    if (select.value === 'Other') {
        otherInput.style.display = 'block';
        otherInput.required = true;
    } else {
        otherInput.style.display = 'none';
        otherInput.required = false;
        otherInput.value = '';
    }
}

// ===== WARNING MODAL FUNCTIONALITY =====
function showWarning(title, message) {
    const warningModal = document.getElementById('warningModal');
    const warningTitle = document.getElementById('warningTitle');
    const warningMessage = document.getElementById('warningMessage');

    warningTitle.textContent = title;
    warningMessage.textContent = message;
    warningModal.style.display = 'block';
}

document.getElementById('warningOkBtn').onclick = function() {
    document.getElementById('warningModal').style.display = 'none';
}

// Set minimum date to today
const dateInput = document.getElementById('visit_date');
const today = new Date().toISOString().split('T')[0];
dateInput.setAttribute('min', today);

// ===== DATE VALIDATION - No Past Dates, No Sundays =====
const visitDateInput = document.getElementById('visit_date');

visitDateInput.addEventListener('input', function() {
    const selectedDate = new Date(this.value + 'T00:00:00');
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Reset time to start of day
    const day = selectedDate.getDay();

    if (selectedDate < today) {
        showWarning(
            'ðŸ“… Invalid Date',
            'You cannot select a date that has already passed. Please select today or a future date.'
        );
        this.value = '';
        return;
    }

    if (day === 0) {
        showWarning(
            'ðŸ“… Sunday Not Available',
            'Visits cannot be scheduled on Sundays. Please select a weekday (Monday-Saturday).'
        );
        this.value = '';
    }
});

// Unfocus select elements after selection
document.getElementById('purpose').addEventListener('change', function() {
    this.blur();
});

document.getElementById('department').addEventListener('change', function() {
    this.blur();
});

// ===== FORM SUBMISSION VALIDATION =====
document.querySelector('form').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');

    // Validate date is not past and not Sunday
    const selectedDate = new Date(visitDateInput.value + 'T00:00:00');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const dayOfWeek = selectedDate.getDay();

    if (selectedDate < today) {
        e.preventDefault();
        showWarning(
            'ðŸ“… Invalid Date',
            'You cannot select a date that has already passed. Please select today or a future date.'
        );
        return false;
    }

    if (dayOfWeek === 0) {
        e.preventDefault();
        showWarning(
            'ðŸ“… Sunday Not Available',
            'Visits cannot be scheduled on Sundays. Please select a weekday (Monday-Saturday).'
        );
        return false;
    }

    // If all validations pass, show loading state
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
});

// ===== AUTO-DISMISS MESSAGES AFTER 5 SECONDS =====
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            alert.style.opacity = '0';
            alert.style.transform = 'translateX(400px)';
            setTimeout(function() {
                alert.remove();
            }, 500);
        }, 5000); // 5 seconds
    });
});
</script>
{% endblock %}