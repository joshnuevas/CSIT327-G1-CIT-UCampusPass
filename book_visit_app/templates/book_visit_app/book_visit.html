{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIT-U Campus Pass - Book a Visit</title>
    <link rel="stylesheet" href="{% static 'book_visit_app/css/book_visit.css' %}?v={{ now|date:'U' }}">
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="school-logo"></div>
        <div class="sidebar-header">
            <h2>CIT-U Campus Pass</h2>
            <p>Visitor Management</p>
        </div>

        <nav class="nav-menu">
            <a href="{% url 'dashboard' %}" class="nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                </svg>
                Dashboard
            </a>

            <a href="{% url 'book_visit' %}" class="nav-item active">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                Book a Visit
            </a>

            <a href="{% url 'visit_history' %}" class="nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                </svg>
                My History
            </a>

            <div class="nav-divider"></div>

            <a href="#" class="nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                </svg>
                Notifications
            </a>

            <a href="#" class="nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                </svg>
                Help & Support
            </a>

            <a href="{% url 'profile' %}" class="nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
                Profile Settings
            </a>

            <a href="#" class="nav-item logout-item" id="logoutBtn">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                </svg>
                Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">
                <h1>Book a Visit</h1>
                <p>Schedule your campus visit</p>
            </div>
            <div class="user-info">
                <div class="notification-icon">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                    </svg>
                    <span class="notification-badge">3</span>
                </div>
                <div class="user-avatar">{{ user.first_name|default:"JD"|slice:":2"|upper }}</div>
            </div>
        </div>

        <div class="content-area">
            <div class="form-container">
                <form method="POST" action="{% url 'book_visit' %}">
                    {% csrf_token %}

                    <!-- Purpose -->
                    <div class="form-group">
                        <label for="purpose" class="required">Purpose</label>
                        <select name="purpose" id="purpose" onchange="toggleOther('purpose')" required>
                            <option value="" selected disabled>Select Purpose</option>
                            <option value="Meeting">Meeting</option>
                            <option value="Tuition Payment">Tuition Payment</option>
                            <option value="Delivery">Delivery</option>
                            <option value="Consultation">Consultation</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="text" name="purpose_other" id="purpose_other" placeholder="Please specify your purpose" style="display:none;">
                    </div>

                    <!-- Department -->
                    <div class="form-group">
                        <label for="department" class="required">Department</label>
                        <select name="department" id="department" onchange="toggleOther('department')" required>
                            <option value="" selected disabled>Select Department</option>
                            <option value="Admissions">Admissions</option>
                            <option value="Finance">Finance/Cashier</option>
                            <option value="Registrar">Registrar</option>
                            <option value="Library">Library</option>
                            <option value="Student Affairs">Student Affairs</option>
                            <option value="IT Services">IT Services</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="text" name="department_other" id="department_other" placeholder="Please specify department" style="display:none;">
                    </div>

                    <!-- Date -->
                    <div class="form-group">
                        <label for="visit_date" class="required">Visit Date</label>
                        <input type="date" name="visit_date" id="visit_date" required>
                        <p class="helper-text">Please select your preferred visit date</p>
                    </div>

                    <!-- Time Fields -->
                    <div class="form-group">
                        <label for="start_time" class="required">Start Time</label>
                        <input type="time" name="start_time" id="start_time" required>
                    </div>

                    <div class="form-group">
                        <label for="end_time" class="required">End Time</label>
                        <input type="time" name="end_time" id="end_time" required>
                    </div>

                    <button type="submit" id="submitBtn">Book Visit</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <h2>Are you sure you want to logout?</h2>
            <div class="modal-buttons">
                <button id="confirmLogout" class="btn-primary">Logout</button>
                <button id="cancelLogout" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Warning Modal for Invalid Selections -->
    <div id="warningModal" class="modal warning-modal">
        <div class="modal-content warning-content">
            <div class="warning-icon">
                <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>
            <h2 id="warningTitle">Oops!</h2>
            <p id="warningMessage">Something went wrong.</p>
            <button id="warningOkBtn" class="btn-warning">Got it!</button>
        </div>
    </div>

    <script>
        function toggleOther(field) {
            const select = document.getElementById(field);
            const otherInput = document.getElementById(field + '_other');
            
            if (select.value === 'Other') {
                otherInput.style.display = 'block';
                otherInput.required = true;
            } else {
                otherInput.style.display = 'none';
                otherInput.required = false;
                otherInput.value = '';
            }
        }

        // ===== WARNING MODAL FUNCTIONALITY =====
        function showWarning(title, message) {
            const warningModal = document.getElementById('warningModal');
            const warningTitle = document.getElementById('warningTitle');
            const warningMessage = document.getElementById('warningMessage');
            
            warningTitle.textContent = title;
            warningMessage.textContent = message;
            warningModal.style.display = 'block';
        }

        document.getElementById('warningOkBtn').onclick = function() {
            document.getElementById('warningModal').style.display = 'none';
        }

        // Set minimum date to today
        const dateInput = document.getElementById('visit_date');
        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('min', today);

        // ===== DATE VALIDATION - Monday-Friday Only =====
        const visitDateInput = document.getElementById('visit_date');

        visitDateInput.addEventListener('input', function() {
            const selectedDate = new Date(this.value + 'T00:00:00');
            const day = selectedDate.getDay();
            
            if (day === 0 || day === 6) {
                showWarning(
                    'üìÖ Weekend Not Available',
                    'Visits cannot be scheduled on Saturdays or Sundays. Please select a weekday (Monday-Friday).'
                );
                this.value = '';
            }
        });

        // ===== TIME VALIDATION =====
        const startTime = document.getElementById('start_time');
        const endTime = document.getElementById('end_time');

        startTime.setAttribute('min', '07:30');
        startTime.setAttribute('max', '21:00');
        endTime.setAttribute('min', '07:30');
        endTime.setAttribute('max', '21:00');

        startTime.addEventListener('change', function() {
            if (this.value < '07:30' || this.value > '21:00') {
                showWarning(
                    'üïê Invalid Time',
                    'Start time must be between 7:30 AM and 9:00 PM.'
                );
                this.value = '';
            }
        });

        endTime.addEventListener('change', function() {
            if (this.value < '07:30' || this.value > '21:00') {
                showWarning(
                    'üïê Invalid Time',
                    'End time must be between 7:30 AM and 9:00 PM.'
                );
                this.value = '';
                return;
            }
            
            if (startTime.value && endTime.value) {
                if (endTime.value <= startTime.value) {
                    showWarning(
                        '‚è∞ Time Conflict',
                        'End time must be after start time. Please adjust your schedule.'
                    );
                    endTime.value = '';
                }
            }
        });

        // Unfocus select elements after selection
        document.getElementById('purpose').addEventListener('change', function() {
            this.blur();
        });

        document.getElementById('department').addEventListener('change', function() {
            this.blur();
        });

        // ===== FORM SUBMISSION VALIDATION =====
        document.querySelector('form').addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('submitBtn');
            
            // Validate date is weekday
            const selectedDate = new Date(visitDateInput.value + 'T00:00:00');
            const dayOfWeek = selectedDate.getDay();
            
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                e.preventDefault();
                showWarning(
                    'üìÖ Weekend Not Available',
                    'Visits cannot be scheduled on Saturdays or Sundays. Please select a weekday.'
                );
                return false;
            }
            
            // Validate time range
            if (startTime.value < '07:30' || startTime.value > '21:00') {
                e.preventDefault();
                showWarning(
                    'üïê Invalid Time',
                    'Start time must be between 7:30 AM and 9:00 PM.'
                );
                return false;
            }
            
            if (endTime.value < '07:30' || endTime.value > '21:00') {
                e.preventDefault();
                showWarning(
                    'üïê Invalid Time',
                    'End time must be between 7:30 AM and 9:00 PM.'
                );
                return false;
            }
            
            if (endTime.value <= startTime.value) {
                e.preventDefault();
                showWarning(
                    '‚è∞ Time Conflict',
                    'End time must be after start time.'
                );
                return false;
            }
            
            // If all validations pass, show loading state
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
        });

        // ===== LOGOUT MODAL =====
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutModal = document.getElementById('logoutModal');
        const confirmLogout = document.getElementById('confirmLogout');
        const cancelLogout = document.getElementById('cancelLogout');

        logoutBtn.onclick = function(e) {
            e.preventDefault();
            logoutModal.style.display = 'block';
        }

        confirmLogout.onclick = function() {
            window.location.href = "{% url 'logout' %}";
        }

        cancelLogout.onclick = function() {
            logoutModal.style.display = 'none';
        }

        // ===== CLOSE MODALS - Click outside to close (BOTH modals) =====
        window.onclick = function(e) {
            const warningModal = document.getElementById('warningModal');
            if(e.target == logoutModal) {
                logoutModal.style.display = 'none';
            }
            if(e.target == warningModal) {
                warningModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
