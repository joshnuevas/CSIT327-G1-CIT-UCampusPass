{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIT-U Campus Pass - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'dashboard_app/css/dashboard.css' %}?v={{ now|date:'U' }}">
</head>
<body>

    <div class="sidebar">
        <div class="school-logo"></div>
        <div class="sidebar-header">
            <h2>CIT-U Campus Pass</h2>
            <p>Visitor Management</p>
        </div>
        <nav class="nav-menu">
            <a href="{% url 'dashboard_app:dashboard' %}" class="nav-item active">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                Dashboard
            </a>

            <a href="{% url 'book_visit_app:book_visit' %}" class="nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                Book a Visit
            </a>

            <a href="{% url 'history_app:visit_history' %}" class="nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                </svg>
                My History
            </a>

            <div class="nav-divider"></div>

            <a href="{% url 'help_app:help_support' %}" class="nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                </svg>
                Help & Support
            </a>

            <a href="{% url 'profile_app:profile' %}" class="nav-item">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
                Profile Settings
            </a>

            <a href="#" class="nav-item logout-item" id="logoutBtn">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                </svg>
                Logout
            </a>
        </nav>
    </div>

    <div class="main-content">

        {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
                <div class="alert-content">
                    <span class="alert-icon">
                        {% if message.tags == 'success' %}
                            ✅
                        {% elif message.tags == 'error' or message.tags == 'danger' %}
                            ❌
                        {% elif message.tags == 'warning' %}
                            ⚠️
                        {% else %}
                            ℹ️
                        {% endif %}
                    </span>
                    <span class="alert-text">{{ message }}</span>
                    <button class="alert-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="top-bar">
            <div class="user-info">
                <div class="user-avatar" id="profileBtn">{{ user_first_name|default:"JD"|slice:":2"|upper }}</div>
            </div>
        </div>

        <div class="content-area">
            <div class="welcome-section">
                <h1>Welcome, {{ user_first_name }}!</h1>
                <p>Here's what's happening with your campus visits today</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card active-pass-stat">
                    <div class="stat-value">{{ active_visits|length }}</div>
                    <div class="stat-label">Active Pass</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ upcoming_visits|length }}</div>
                    <div class="stat-label">Upcoming Visits</div>
                </div>
                <div class="stat-card total-visits-stat">
                    <div class="stat-value">{{ total_visits }}</div>
                    <div class="stat-label">Expired Pass</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Visit Codes</h3>
                        <a href="{% url 'history_app:visit_history' %}" class="view-all">View All →</a>
                    </div>

                    {% now "Y-m-d" as today %}
                    {% for visit in visits %}
                        <div class="pass-code-item">
                            <div class="pass-code-info">
                                <h4>{{ visit.code }}</h4>
                                <p>{{ visit.display_date }} • {{ visit.formatted_start_time }} - {{ visit.formatted_end_time }} • {{ visit.purpose }}</p>
                            </div>
                            <span class="pass-status status-{{ visit.status|lower }}">{{ visit.status }}</span>
                        </div>
                    {% empty %}
                        <p>No visits found.</p>
                    {% endfor %}

                    <div style="margin-top: 20px;">
                        <a href="{% url 'book_visit_app:book_visit' %}" class="quick-action-btn">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                            </svg>
                            Book New Visit
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ===== PROFILE DROPDOWN ===== -->
    <div class="dropdown" id="profileDropdown">
        <div class="dropdown-header">Visitor</div>
        <a href="{% url 'profile_app:profile' %}" class="dropdown-item">
            <i class="fas fa-user"></i> Profile
        </a>
        <div class="dropdown-item" id="dropdownLogoutBtn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </div>
    </div>

    <!-- ===== Login Success Modal ===== -->
    {% for message in messages %}
        {% if 'login-success' in message.tags %}
            <div id="successModal" class="modal">
                <div class="modal-content">
                    <h2>{{ message }}</h2>
                    <button id="continueBtn">Continue</button>
                </div>
            </div>
        {% endif %}
    {% endfor %}

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <h2>Are you sure you want to logout?</h2>
            <div class="modal-buttons">
                <button id="confirmLogout" class="btn-primary">Logout</button>
                <button id="cancelLogout" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ===== Login Success Modal =====
        window.onload = function() {
            const successModal = document.getElementById('successModal');
            const continueBtn = document.getElementById('continueBtn');

            if(successModal){
                successModal.style.display = 'block';
                continueBtn.onclick = function() {
                    successModal.style.display = 'none';
                }
                window.onclick = function(e) {
                    if(e.target == successModal) successModal.style.display = 'none';
                }
            }
        }

        // ===== DROPDOWNS =====
        const profileBtn = document.getElementById("profileBtn");
        const profileDropdown = document.getElementById("profileDropdown");

        if (profileBtn) {
            profileBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle("active");
            });
        }

        document.addEventListener("click", (e) => {
            if (profileDropdown && profileBtn && !profileDropdown.contains(e.target) && !profileBtn.contains(e.target))
                profileDropdown.classList.remove("active");
        });

        // ===== Logout Confirmation Modal =====
        const logoutBtn = document.getElementById('logoutBtn');
        const dropdownLogoutBtn = document.getElementById('dropdownLogoutBtn');
        const logoutModal = document.getElementById('logoutModal');
        const confirmLogout = document.getElementById('confirmLogout');
        const cancelLogout = document.getElementById('cancelLogout');

        if(logoutBtn) logoutBtn.onclick = function(e) {
            e.preventDefault(); // prevent immediate logout
            logoutModal.style.display = 'block';
        }

        if(dropdownLogoutBtn) dropdownLogoutBtn.addEventListener("click", e=>{ e.preventDefault(); profileDropdown.classList.remove('active'); logoutModal.style.display = 'block'; });

        if(confirmLogout) confirmLogout.onclick = function() {
            window.location.href = "{% url 'login_app:logout' %}"; // perform logout
        }

        if(cancelLogout) cancelLogout.onclick = function() {
            logoutModal.style.display = 'none';
        }

        window.onclick = function(e) {
            if(e.target == logoutModal) logoutModal.style.display = 'none';
        }
    </script>
</body>
</html>