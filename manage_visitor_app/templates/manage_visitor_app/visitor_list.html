{% extends "dashboard_app/admin_dashboard_base.html" %}
{% load static %}
{% block visitor_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'manage_visitor_app/css/visitor_list.css' %}">
{% endblock %}

{% block content %}
<div class="content-header">
  <h1>Registered Visitors</h1>
</div>

{% if messages %}
  {% for message in messages %}
    <div class="message {% if message.tags %}message-{{ message.tags }}{% endif %}">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Full Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Visitor Type</th>
        <th>Register Date</th>
        <th style="text-align:center;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for v in visitors %}
      <tr>
        <td>{{ v.user_id }}</td>
        <td>{{ v.first_name }} {{ v.last_name }}</td>
        <td>{{ v.email }}</td>
        <td>{{ v.phone }}</td>
        <td>{{ v.visitor_type|default:"N/A" }}</td>
        <td>
            {% if v.created_at %}
                {{ v.created_at|slice:":10" }}
            {% else %}
                N/A
            {% endif %}
        </td>
        <td style="text-align:center;">
          <a href="{% url 'manage_visitor_app:visitor_deactivate' v.user_id %}" 
             class="action-item open-modal" 
             data-action="delete" 
             data-username="{{ v.first_name }} {{ v.last_name }}"
             data-email="{{ v.email }}">
            <i class="fas fa-trash-alt"></i> Remove
          </a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" style="text-align:center; color:#777;">No visitors found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Remove Visitor Confirmation Modal -->
<div id="removeVisitorModal" class="modal">
    <div class="modal-content">
        <h2 id="removeVisitorText">Are you sure you want to remove this visitor?</h2>
        <div class="modal-buttons">
            <button id="confirmRemoveVisitor" class="btn-primary">Remove</button>
            <button id="cancelRemoveVisitor" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const removeModal = document.getElementById("removeVisitorModal");
    const removeText = document.getElementById("removeVisitorText");
    const confirmRemoveBtn = document.getElementById("confirmRemoveVisitor");
    const cancelRemoveBtn = document.getElementById("cancelRemoveVisitor");

    let removeUrl = "";

    // Open modal on click
    document.querySelectorAll(".open-modal[data-action='delete']").forEach(btn => {
        btn.addEventListener("click", function(e) {
            e.preventDefault();
            const username = this.dataset.username;
            const email = this.dataset.email;
            removeUrl = this.href;

            removeText.textContent = `Are you sure you want to remove ${username} (${email})?`;
            removeModal.style.display = "block";
        });
    });

    // Confirm removal
    confirmRemoveBtn.addEventListener("click", function() {
        if (removeUrl) {
            window.location.href = removeUrl;
        }
    });

    // Cancel removal
    cancelRemoveBtn.addEventListener("click", function() {
        removeModal.style.display = "none";
    });

    // Close modal when clicking outside
    window.addEventListener("click", function(e) {
        if (e.target === removeModal) {
            removeModal.style.display = "none";
        }
    });
});
</script>

{% endblock %}
