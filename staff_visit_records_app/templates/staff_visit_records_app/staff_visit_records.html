{% extends "dashboard_app/staff_dashboard_base.html" %}
{% load static %}
{% block title %}Visit Records - CIT-U Campus Pass{% endblock %}

{% block records_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'history_app/css/history.css' %}?v={{ now|date:'U' }}">

<style>
/* Use the VISITOR button design, but only for the filter buttons on this page */

/* Apply Filters */
.filter-section .filter-actions .btn-pill.btn-primary {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 14px 32px;
  background: linear-gradient(135deg, #8B1538, #6B0F2A);
  color: #FFFFFF;
  border: none;
  border-radius: 50px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(139, 21, 56, 0.3);
  text-decoration: none;
}

/* Reset (copy of visitor .btn-secondary but matching your class name) */
.filter-section .filter-actions .btn-pill.btn-secondary-outline {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 14px 32px;
  background: #FFFFFF;
  color: #666666;
  border: 2px solid #E0E0E0;
  border-radius: 50px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
}

.filter-section .filter-actions .btn-pill.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 25px rgba(139, 21, 56, 0.4);
  background: linear-gradient(135deg, #6B0F2A, #8B1538);
}

.filter-section .filter-actions .btn-pill.btn-secondary-outline:hover {
  border-color: #8B1538;
  color: #8B1538;
  transform: translateY(-2px);
}
</style>
{% endblock %}

{% block content %}
<div class="welcome-section">
    <div class="welcome-text">
        <h1>Visit Records</h1>
        <p>View all visitor passes for a specific date. Default view shows today.</p>
    </div>
</div>

<div class="filter-section">
    <form method="get" class="filter-form">
        <input type="hidden" name="filter_submitted" value="1">
        <div class="filter-row">
            <div class="filter-group">
                <label for="filter_date">Filter by Date</label>
                <div class="input-icon-wrapper">
                    <input type="date"
                           id="filter_date"
                           name="date"
                           value="{{ filter_date }}"
                           class="input-modern">
                </div>
            </div>
            <div class="filter-group filter-search-group">
                <label for="search_query">Search Visits</label>
                <div class="search-input-wrapper">
                    <svg width="20" height="20" fill="none" stroke="currentColor"
                         viewBox="0 0 24 24" class="search-icon">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text"
                           id="search_query"
                           name="q"
                           placeholder="Search by Code, Email, Department or Purpose..."
                           value="{{ filter_query }}"
                           class="input-modern">
                </div>
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn-pill btn-primary">
                    Apply Filters
                </button>
                <a href="{% url 'staff_visit_records_app:staff_visit_records' %}"
                class="btn-pill btn-secondary-outline">
                    Reset
                </a>
            </div>
        </div>
    </form>
</div>

{% if visits %}
    <div class="visit-grid-3d">
        {% for visit in visits %}
            <div class="flip-card-scene">
                <div class="flip-card-inner
                    {% if visit.status|lower == 'upcoming' or visit.status|lower == 'active' %}
                        interactive-card
                    {% elif visit.status|lower == 'completed' or visit.status|lower == 'expired' %}
                        card-inactive
                    {% endif %}
                    {% if visit.visit_date == today %}is-today-card{% endif %}"
                    id="card-{{ visit.visit_id }}"
                    data-status="{{ visit.status|lower }}">

                    {# ---------- FRONT ---------- #}
                    <div class="card-face card-front">
                        <div class="status-stripe status-{{ visit.status|lower }}"></div>

                        <div class="front-content">
                            <div class="front-header">
                                <div class="code-badge">
                                    <span class="code-label">CODE</span>
                                    <span class="code-text">{{ visit.code }}</span>
                                </div>

                                {% if visit.visit_date == today %}
                                    <span class="today-history-badge">TODAY</span>
                                {% endif %}

                                <span class="status-pill status-{{ visit.status|lower }}">
                                    {{ visit.status }}
                                </span>
                            </div>

                            <div class="front-body">
                                <h3 class="visit-purpose single-line"
                                    title="{{ visit.purpose }}">
                                    {{ visit.purpose }}
                                </h3>

                                <div class="visit-department single-line"
                                     title="{{ visit.department }}">
                                    <svg width="14" height="14" fill="none" stroke="currentColor"
                                         viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2"
                                              d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                                        </path>
                                    </svg>
                                    <span class="dept-text">{{ visit.department }}</span>
                                </div>
                            </div>

                            <div class="card-divider"></div>

                            <div class="front-footer">
                                <div class="meta-col">
                                    <span class="meta-label">DATE</span>
                                    <span class="meta-value">
                                        {{ visit.visit_date|date:"M j, Y" }}
                                    </span>
                                </div>
                                <div class="meta-col">
                                    <span class="meta-label">TIME</span>
                                    <span class="meta-value">
                                        {% if visit.status == 'Upcoming' %}
                                            Not checked in

                                        {% elif visit.status == 'Active' %}
                                            Checked in at {{ visit.start_time|time:"h:i A" }}, not yet checked out

                                        {% elif visit.status == 'Completed' %}
                                            {{ visit.start_time|time:"h:i A" }} â€“ {{ visit.end_time|time:"h:i A" }}

                                        {% elif visit.status == 'Expired' %}
                                            Visit expired (not checked in)

                                        {% else %}
                                            --
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            {% if visit.status|lower == 'upcoming' or visit.status|lower == 'active' %}
                                <div class="tap-indicator-row">
                                    <span class="tap-text">Tap to open in Code Checker</span>
                                    <svg width="12" height="12" fill="none" stroke="currentColor"
                                         viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2"
                                              d="M13 7l5 5m0 0l-5 5m5-5H6">
                                        </path>
                                    </svg>
                                </div>
                            {% else %}
                                <div class="tap-spacer"></div>
                            {% endif %}
                        </div>
                    </div>

                    {# ---------- BACK (Upcoming + Active) ---------- #}
                    {% if visit.status|lower == 'upcoming' or visit.status|lower == 'active' %}
                        <div class="card-face card-back">
                            <div class="back-content">
                                <div class="back-header">
                                    <h4>Open in Code Checker</h4>
                                    <button type="button"
                                            class="btn-close-flip"
                                            onclick="flipCardBack(event, 'card-{{ visit.visit_id }}')">
                                        <svg width="20" height="20" fill="none" stroke="currentColor"
                                             viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                  stroke-width="2"
                                                  d="M6 18L18 6M6 6l12 12">
                                            </path>
                                        </svg>
                                    </button>
                                </div>

                                <div class="back-body">
                                    <div class="warning-icon-sm">
                                        <svg width="24" height="24" fill="none" stroke="currentColor"
                                             viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                  stroke-width="2"
                                                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4
                                                       c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                            </path>
                                        </svg>
                                    </div>

                                    <p>
                                        Send this pass to the Quick Pass Validator
                                        to process check-in or check-out.
                                    </p>

                                    <div class="visit-code-display">{{ visit.code }}</div>
                                </div>

                                <div class="back-actions">
                                    <form method="POST" action="{% url 'dashboard_app:check_code' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="visit_code" value="{{ visit.code }}">
                                        <button type="submit" class="btn-cancel-full">
                                            Open in Code Checker
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state-container">
        <div class="empty-icon-bg">
            <svg width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                </path>
            </svg>
        </div>
        <h3>No visits found</h3>
        <p>We couldn't find any visits matching your filters.</p>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== LIMIT FILTER DATE TO TODAY + 7 DAYS (same as user) =====
    const filterDateInput = document.getElementById('filter_date');

    function formatLocalDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    if (filterDateInput) {
        const today = new Date();
        today.setHours(0,0,0,0);

        const maxDate = new Date(today);
        maxDate.setDate(maxDate.getDate() + 7);

        const maxStr = formatLocalDate(maxDate);
        filterDateInput.setAttribute('max', maxStr);
    }

    // ===== FLIP LOGIC (Upcoming + Active only) =====
    document.querySelectorAll('.flip-card-inner').forEach(card => {
        const status = (card.dataset.status || '').toLowerCase();
        const canFlip = (status === 'upcoming' || status === 'active');

        if (!canFlip) return;

        card.classList.add('interactive-card');

        card.addEventListener('click', function(e) {
            // Ignore clicks on buttons (code checker / close)
            if (e.target.closest('button')) return;
            this.classList.toggle('is-flipped');
        });
    });
});

function flipCardBack(event, cardId) {
    event.stopPropagation();
    const card = document.getElementById(cardId);
    if (card) card.classList.remove('is-flipped');
}
</script>
{% endblock %}
