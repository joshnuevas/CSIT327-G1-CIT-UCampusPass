{% extends "dashboard_app/staff_dashboard_base.html" %}
{% load static %}
{% block title %}CIT-U Campus Pass - Staff Visit Records{% endblock %}

{% block records_active %}active{% endblock %}

{% block extra_css %}
<style>
.check-in-btn, .check-out-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #8B1538, #6B0F2A);
    color: #FFFFFF;
    border: none;
    border-radius: 50px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(139, 21, 56, 0.3);
}

.check-in-btn:hover, .check-out-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(139, 21, 56, 0.4);
    background: linear-gradient(135deg, #6B0F2A, #8B1538);
}

.check-in-btn.checked {
    background: linear-gradient(135deg, #28a745, #20c997);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.check-in-btn.checked:hover {
    background: linear-gradient(135deg, #20c997, #28a745);
    box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4);
}

.check-in-btn svg, .check-out-btn svg {
    width: 16px;
    height: 16px;
}

.visit-date {
    display: block;
    font-size: 0.9em;
    color: #666;
    margin-top: 4px;
}

/* ===== Welcome Section ===== */
.welcome-section h1 {
    color: #8B1538;
    font-size: 34px;
    margin-bottom: 8px;
    font-weight: 700;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
}

.welcome-section p {
    color: #555555;
    font-size: 16px;
}

/* ===== Filter Section ===== */
.filter-section {
    margin-bottom: 30px;
}

.filter-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 12px 24px;
    background: #FFFFFF;
    border: 2px solid #E0E0E0;
    border-radius: 50px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #666666;
}

.filter-btn:hover {
    border-color: #8B1538;
    color: #8B1538;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 21, 56, 0.15);
}

.filter-btn.active {
    background: linear-gradient(135deg, #8B1538, #6B0F2A);
    color: #FFFFFF;
    border-color: #8B1538;
    box-shadow: 0 4px 15px rgba(139, 21, 56, 0.3);
}

/* ===== Visit List ===== */
.visit-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 22px;
    margin-bottom: 30px;
}

.visit-card {
    background: #FFFFFF;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    border: 2px solid #F0F0F0;
    border-left-width: 4px;
}

.visit-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(139, 21, 56, 0.15);
    border-left-color: #8B1538;
}

.visit-card.status-active {
    border-left-color: #4CAF50;
}

.visit-card.status-upcoming {
    border-left-color: #D4AF37;
}

.visit-card.status-completed,
.visit-card.status-expired {
    border-left-color: #999999;
}

.visit-header {
    margin-bottom: 18px;
    padding-bottom: 16px;
    border-bottom: 2px solid #F5F5F5;
}

.visit-code-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.visit-code-section h3 {
    font-size: 20px;
    color: #8B1538;
    font-family: 'Courier New', monospace;
    letter-spacing: 1.5px;
    font-weight: 700;
}

.status-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.status-active {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    color: #FFFFFF;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
}

.status-badge.status-upcoming {
    background: #FFF8E1;
    color: #D4AF37;
    border: 2px solid #D4AF37;
}

.status-badge.status-completed,
.status-badge.status-expired {
    background: #F5F5F5;
    color: #999999;
    border: 2px solid #E0E0E0;
}

.visit-details {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.detail-row {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: #666666;
}

.detail-row svg {
    color: #8B1538;
    flex-shrink: 0;
}

.purpose-row {
    padding-top: 8px;
    border-top: 1px solid #F5F5F5;
    font-weight: 500;
    color: #333333;
}

/* ===== Card Actions ===== */
.card-actions {
    margin-top: 18px;
    padding-top: 16px;
    border-top: 2px solid #F5F5F5;
    display: flex;
    justify-content: flex-end;
}

/* ===== Empty State ===== */
.empty-state {
    text-align: center;
    padding: 80px 20px;
    background: #FFFFFF;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.empty-state svg {
    color: #D4AF37;
    margin-bottom: 20px;
    opacity: 0.6;
}

.empty-state h3 {
    color: #8B1538;
    font-size: 24px;
    margin-bottom: 10px;
    font-weight: 600;
}

.empty-state p {
    color: #666666;
    font-size: 16px;
    margin-bottom: 30px;
}

/* ===== Modal Styles ===== */
.modal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.45);
    backdrop-filter: blur(3px);
    animation: fadeIn 0.3s ease forwards;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: linear-gradient(135deg, #fff8f5, #fff1e5);
    padding: 35px 30px;
    border-radius: 25px;
    width: 90%;
    max-width: 450px;
    text-align: center;
    box-shadow: 0 15px 50px rgba(139, 21, 56, 0.3);
    transform: translateY(-20px);
    animation: slideDown 0.4s ease forwards;
    position: relative;
}

.modal-content h2 {
    color: #8B1538;
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 30px;
    letter-spacing: 0.5px;
}

.modal-description {
    color: #666666;
    font-size: 15px;
    margin-bottom: 30px;
    line-height: 1.6;
}

.modal-description strong {
    color: #8B1538;
    font-weight: 700;
}

.modal-icon-warning {
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
}

.modal-icon-warning svg {
    color: #FFA500;
    filter: drop-shadow(0 4px 8px rgba(255, 165, 0, 0.3));
}

.modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== Responsive Design ===== */
@media (max-width: 1024px) {
    .visit-list {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
}

@media (max-width: 768px) {
    .visit-list {
        grid-template-columns: 1fr;
    }

    .welcome-section h1 {
        font-size: 26px;
    }

    .filter-buttons {
        gap: 8px;
    }

    .filter-btn {
        padding: 10px 18px;
        font-size: 13px;
    }

    .modal-content {
        padding: 25px 20px;
    }

    .modal-buttons {
        flex-direction: column;
    }

    .btn-primary, .btn-secondary {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="welcome-section">
    <h1>Visit Records</h1>
    <p>View and manage all visit records organized by status.</p>
</div>

<div class="filter-section">
    <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all">All Visits</button>
        <button class="filter-btn" data-filter="upcoming">Upcoming Visits</button>
        <button class="filter-btn" data-filter="active">Active Visits</button>
        <button class="filter-btn" data-filter="checked_out">Checked-Out Visits</button>
    </div>
</div>

<div class="visit-list">
    {% for visit in categorized_visits.all_visits %}
    <div class="visit-card status-{{ visit.status|lower }}" data-status="{{ visit.status|lower }}" data-visit-date="{{ visit.visit_date|date:'Y-m-d' }}">
        <div class="visit-header">
            <div class="visit-code-section">
                <h3>{{ visit.code }}</h3>
                <span class="status-badge status-{{ visit.status|lower }}">{{ visit.status }}</span>
            </div>
            <span class="visit-date">{{ visit.visit_date }}</span>
        </div>
        <div class="visit-details">
            <div class="detail-row">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                </svg>
                <span>{{ visit.user_email }}</span>
            </div>
            <div class="detail-row">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"/>
                </svg>
                <span>{{ visit.department }}</span>
            </div>
            <div class="detail-row purpose-row">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                </svg>
                <span>{{ visit.purpose }}</span>
            </div>
            {% if visit.status|lower == "active" or visit.status|lower == "ongoing" %}
            <div class="detail-row">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                <span>Checked in: {{ visit.start_time|slice:":5"|default:"N/A" }}</span>
            </div>
            {% elif visit.status|lower == "completed" or visit.status|lower == "expired" %}
            <div class="detail-row">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                </svg>
                <span>Checked in: {{ visit.start_time|slice:":5"|default:"N/A" }} | Checked out: {{ visit.end_time|slice:":5"|default:"N/A" }}</span>
            </div>
            {% endif %}
        </div>

        {% if visit.status|lower == "active" or visit.status|lower == "ongoing" %}
        <div class="card-actions">
            <button class="check-out-btn" data-visit-id="{{ visit.visit_id }}" data-visit-code="{{ visit.code }}" data-visitor-email="{{ visit.user_email }}">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                </svg>
                Check Out
            </button>
        </div>
        {% elif visit.status|lower == "upcoming" and visit.visit_date == today %}
        <div class="card-actions">
            <button class="check-in-btn" data-visit-id="{{ visit.visit_id }}" data-visit-code="{{ visit.code }}" data-visitor-email="{{ visit.user_email }}">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                Check In
            </button>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<div class="empty-state" id="empty-state" style="display: none;">
    <svg width="80" height="80" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
    </svg>
    <h3 id="empty-title">No visits found</h3>
    <p id="empty-message">No visit records are available at this time.</p>
</div>

<!-- Check In Confirmation Modal -->
<div id="checkInModal" class="modal">
    <div class="modal-content">
        <div class="modal-icon-warning">
            <svg width="60" height="60" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
        </div>
        <h2>Check In Visitor?</h2>
        <p class="modal-description">Are you sure you want to check in <strong id="checkInVisitCode"></strong> (<span id="checkInVisitorEmail"></span>)?</p>
        <div class="modal-buttons">
            <button id="confirmCheckIn" class="btn-primary">Check In</button>
            <button id="cancelCheckIn" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<!-- Check Out Confirmation Modal -->
<div id="checkOutModal" class="modal">
    <div class="modal-content">
        <div class="modal-icon-warning">
            <svg width="60" height="60" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
            </svg>
        </div>
        <h2>Check Out Visitor?</h2>
        <p class="modal-description">Are you sure you want to check out <strong id="checkOutVisitCode"></strong> (<span id="checkOutVisitorEmail"></span>)?</p>
        <div class="modal-buttons">
            <button id="confirmCheckOut" class="btn-primary">Check Out</button>
            <button id="cancelCheckOut" class="btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<!-- Hidden forms for check-in/check-out actions -->
<form id="checkInForm" method="POST" action="{% url 'staff_visit_records_app:check_in_visitor' %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="visit_id" id="checkInVisitIdInput">
</form>

<form id="checkOutForm" method="POST" action="{% url 'staff_visit_records_app:check_out_visitor' %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="visit_id" id="checkOutVisitIdInput">
</form>

<!-- JSON data for JS -->
<script id="visits-data" type="application/json">
{{ visits_json|safe }}
</script>
{% endblock %}

{% block extra_js %}
<script>
var serverToday = "{{ today }}";
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const visitCards = document.querySelectorAll('.visit-card');

    // Filter functionality
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const filter = btn.getAttribute('data-filter');

            filterButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            let visibleCount = 0;
            visitCards.forEach(card => {
                const status = card.getAttribute('data-status');
                let show = false;

                if (filter === 'all') {
                    show = true;
                } else if (filter === 'upcoming' && status === 'upcoming') {
                    show = true;
                } else if (filter === 'active' && (status === 'active' || status === 'ongoing')) {
                    show = true;
                } else if (filter === 'checked_out' && (status === 'completed' || status === 'expired')) {
                    show = true;
                }

                card.style.display = show ? 'block' : 'none';
                if (show) visibleCount++;
            });

            // Show empty state if no visits match the filter
            const emptyState = document.getElementById('empty-state');
            const emptyTitle = document.getElementById('empty-title');
            const emptyMessage = document.getElementById('empty-message');

            if (visibleCount === 0) {
                let title, message;
                if (filter === 'all') {
                    title = 'No visits found';
                    message = 'No visit records are available at this time.';
                } else if (filter === 'upcoming') {
                    title = 'No upcoming visits';
                    message = 'There are no upcoming visits scheduled.';
                } else if (filter === 'active') {
                    title = 'No active visits';
                    message = 'There are no active visits at the moment.';
                } else if (filter === 'checked_out') {
                    title = 'No checked-out visits';
                    message = 'There are no recently checked-out visits.';
                }
                emptyTitle.textContent = title;
                emptyMessage.textContent = message;
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
            }
        });
    });

    // Check In Modal
    const checkInModal = document.getElementById('checkInModal');
    const confirmCheckIn = document.getElementById('confirmCheckIn');
    const cancelCheckIn = document.getElementById('cancelCheckIn');
    const checkInButtons = document.querySelectorAll('.check-in-btn');
    let currentCheckInVisitId = null;

    checkInButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            currentCheckInVisitId = this.getAttribute('data-visit-id');
            const visitCode = this.getAttribute('data-visit-code');
            const visitorEmail = this.getAttribute('data-visitor-email');
            document.getElementById('checkInVisitCode').textContent = visitCode;
            document.getElementById('checkInVisitorEmail').textContent = visitorEmail;
            checkInModal.style.display = 'flex';
        });
    });

    confirmCheckIn.onclick = function() {
        if (currentCheckInVisitId) {
            document.getElementById('checkInVisitIdInput').value = currentCheckInVisitId;
            document.getElementById('checkInForm').submit();
        }
    }

    cancelCheckIn.onclick = function() {
        checkInModal.style.display = 'none';
        currentCheckInVisitId = null;
    }

    // Check Out Modal
    const checkOutModal = document.getElementById('checkOutModal');
    const confirmCheckOut = document.getElementById('confirmCheckOut');
    const cancelCheckOut = document.getElementById('cancelCheckOut');
    const checkOutButtons = document.querySelectorAll('.check-out-btn');
    let currentCheckOutVisitId = null;

    checkOutButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            currentCheckOutVisitId = this.getAttribute('data-visit-id');
            const visitCode = this.getAttribute('data-visit-code');
            const visitorEmail = this.getAttribute('data-visitor-email');
            document.getElementById('checkOutVisitCode').textContent = visitCode;
            document.getElementById('checkOutVisitorEmail').textContent = visitorEmail;
            checkOutModal.style.display = 'flex';
        });
    });

    confirmCheckOut.onclick = function() {
        if (currentCheckOutVisitId) {
            document.getElementById('checkOutVisitIdInput').value = currentCheckOutVisitId;
            document.getElementById('checkOutForm').submit();
        }
    }

    cancelCheckOut.onclick = function() {
        checkOutModal.style.display = 'none';
        currentCheckOutVisitId = null;
    }

    // Close modals when clicking outside
    window.onclick = function(e) {
        if (e.target == checkInModal) {
            checkInModal.style.display = 'none';
            currentCheckInVisitId = null;
        }
        if (e.target == checkOutModal) {
            checkOutModal.style.display = 'none';
            currentCheckOutVisitId = null;
        }
    }
});
</script>
{% endblock %}