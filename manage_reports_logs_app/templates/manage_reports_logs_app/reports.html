{% extends "dashboard_app/admin_dashboard_base.html" %}
{% load static %}

{% block title %}Analytics Dashboard - CIT-U Campus Pass{% endblock %}
{% block reports_active %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'manage_reports_logs_app/css/reports.css' %}?v={{ now|date:'U' }}">
{% endblock %}

{% block content %}
<div class="reports-header animate-entry">
    <div class="header-title">
        <h1>Analytics Dashboard</h1>
        <p>Operational insights, traffic patterns, and visitor data</p>
    </div>
    
    <div class="control-toolbar">
        <div class="toolbar-group">
            <span class="toolbar-label">Quick Range</span>
            <div class="preset-buttons">
                <button class="btn-preset" data-range="7days">Last 7 Days</button>
                <button class="btn-preset" data-range="30days">Last 30 Days</button>
                <button class="btn-preset active" data-range="month">This Month</button>
            </div>
        </div>

        <div class="toolbar-divider"></div>

        <div class="toolbar-group inputs-group">
            <div class="date-range-wrapper">
                <input type="date" id="startDate" class="form-input">
                <span class="range-sep">to</span>
                <input type="date" id="endDate" class="form-input">
            </div>
            
            <div class="action-menu">
                <button class="status-filter-btn" id="statusFilterToggle">
                    <span id="statusFilterText">All Status</span>
                    <i class="fas fa-chevron-down" style="margin-left: 8px;"></i>
                </button>

                <div class="action-dropdown" id="statusFilterDropdown">
                    <button class="action-item" data-value="All">All Status</button>
                    <button class="action-item" data-value="Upcoming">Upcoming</button>
                    <button class="action-item" data-value="Active">Active</button>
                    <button class="action-item" data-value="Completed">Completed</button>
                    <button class="action-item" data-value="Expired">Expired</button>
                </div>
            </div>

            <div class="toolbar-divider"></div>

            <div class="action-menu">
                <button class="export-btn-trigger action-toggle" id="exportToggle">
                    <i class="fas fa-file-export"></i> Export
                </button>
                <div class="action-dropdown" id="exportDropdown">
                    <button id="exportCSV" class="action-item">
                        <i class="fas fa-file-csv" style="color: #059669"></i> Export as CSV
                    </button>
                    <button id="exportPDF" class="action-item">
                        <i class="fas fa-file-pdf" style="color: #dc2626"></i> Export as PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="kpi-grid animate-entry" style="animation-delay: 0.1s;">
    <div class="stat-card">
        <div class="stat-icon-wrapper icon-maroon">
            <i class="fas fa-user-friends"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="totalVisits">0</div>
            <div class="stat-label">Total Visits</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon-wrapper icon-gold">
            <i class="fas fa-walking"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="ongoingVisits">0</div>
            <div class="stat-label">Currently On Campus</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon-wrapper icon-blue">
            <i class="fas fa-calendar-week"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="peakDay">-</div>
            <div class="stat-label">Busiest Day of Week</div>
        </div>
    </div>
</div>

<div class="charts-grid animate-entry" style="animation-delay: 0.2s;">
    
    <div class="card full-width-card">
        <div class="card-header with-controls">
            <div class="header-left">
                <h3 class="card-title"><i class="fas fa-chart-area"></i> Visit Traffic Trends</h3>
            </div>
            <div class="header-controls">
                <div class="toggle-group">
                    <button class="btn-toggle active" data-scale="day">Day</button>
                    <button class="btn-toggle" data-scale="week">Week</button>
                    <button class="btn-toggle" data-scale="month">Month</button>
                </div>
            </div>
        </div>
        <div class="card-content chart-lg">
            <canvas id="visitTrendsChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Peak Hourly Traffic (Avg)</h3>
        </div>
        <div class="card-content chart-md">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Top Departments</h3>
        </div>
        <div class="card-content chart-md">
            <canvas id="deptChart"></canvas>
        </div>
    </div>

    <div class="card full-width-card">
        <div class="card-header">
            <h3 class="card-title">Top Reasons for Visiting</h3>
        </div>
        <div class="card-content scrollable-list">
            <div id="purposeList" class="leaderboard-container">
                </div>
        </div>
    </div>

</div>

<script id="visits-data" type="application/json">
    {{ visits_json|safe }}
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="{% static 'manage_reports_logs_app/js/reports.js' %}?v={{ now|date:'U' }}"></script>
{% endblock %}